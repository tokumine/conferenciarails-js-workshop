<html>
  <head>
    <script src="/js/jquery-1.6.2.min.js"></script>
    <script src="/js/underscore.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <script>

      $(document).ready(function() {

        // SET this to your IP :)
        var socket = io.connect('http://192.168.1.35');
        var usernames;
        var me = prompt('Hi there! Please enter your username')
            
        socket.emit('username', me);
      
        socket.on('ready', function () {
          logger('You are now connected!');
        
          navigator.geolocation.getCurrentPosition(geoOk, geoErr, {maximumAge: 100});
        
          setInterval(function(){
            navigator.geolocation.getCurrentPosition(geoOk, geoErr, {maximumAge: 100});
          }, 5000);
        
        });
      
        socket.on('announcement', function (msg){
          logger(msg);
        });

        socket.on('usernames', function (data){
          usernames = data;
          updateUserlist();
        });
      
        socket.on('location_data', function (user, data){        
          usernames[user] = data;
          updateUserlist();        
        });
                        
        function logger(message){
          $('#log').append('<li>' + message + '</li>')
        }
      
        function geoOk(position){
          // show your location in log
          logger(positionToString(position.coords));
        
          // sent your location to all the other users
          socket.emit('update_location', position.coords);        
        }
      
        function geoErr(){
           logger('Unable to determine your location.');
        }
      
        function positionToString(pos){
          return "lat: " + pos.latitude + ", long: " + pos.longitude + ", accuracy: " + pos.accuracy
        }
      
        function updateUserlist(){
          $('#users').html('');
        
          _.each(usernames, function(position, user){
            if (user !== me){
              $('#users').append(user + ": " + positionToString(position) + '<br/>');
            }            
          });        
        }
      });
    </script>
  </head>

  <body>
    Realtime Geolocation API test
    
    <h5>Users</h5>    
    <div id="users"> </div>

    <h5>Log</h5>    
    <div id="log_container">
      <ul id="log">
      </ul>  
    </div>
  </body>
</html>  